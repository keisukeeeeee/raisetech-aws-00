version: 2.1

orbs:
  python: circleci/python@2.0.3
  aws-cli: circleci/aws-cli@4.1.3
  ansible-playbook: orbss/ansible-playbook@0.0.5

jobs:
  cfn-lint:
    executor: python/default
    steps:
      - checkout
      - run: pip install cfn-lint
      - run:
          name: run cfn-lint
          command: |
            cfn-lint -i W3002 -t cloudformation/*.yml
  cloud-formation-deploy:
    executor: aws-cli/default
    steps:
      - checkout
      - aws-cli/setup:
          aws_access_key_id: AWS_ACCESS_KEY_ID
          aws_secret_access_key: AWS_SECRET_ACCESS_KEY
          region: AWS_DEFAULT_REGION
      - run:
          name: deploy cloudformation
          command: |
            aws cloudformation deploy \
            --template-file cloudformation/cf10aws.yml \
            --stack-name cci-aws-cf \
            --capabilities CAPABILITY_NAMED_IAM \
            --parameter-overrides RdsMyUserPassword=adminadmin
      - run:
          name: delete cloudformation stack
          command: |
            aws cloudformation delete-stack \
              --stack-name cci-aws-cf \
              --region AWS_DEFAULT_REGION
#  ansible-playbook:
#    executor: ansible-playbook/default
#    steps:
#      - checkout
#      - add_ssh_keys:
#          fingerprints:
#            - "SHA256: ULjv9tfyMZOB8aYBSgy1+XBD1dygIVbVetDqcomUn9A"
#      - ansible-playbook/install:
#          version: 2.16.3
#      - ansible-playbook/playbook:

workflows:
  circleci-cloudformation:
    jobs:
      - cfn-lint
      - cloud-formation-deploy
#      - ansible-playbook
